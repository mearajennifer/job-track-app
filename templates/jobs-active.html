{% extends 'base.html' %}

{% block content %}

<table id="active-jobs-table" class="table">
  <!-- TABLE HEADERS -->
  <thead>
    <tr>
      <th scope="col-2"><a href="javascript:SortTable(0, 'T');">Company</a></th>
      <th scope="col-2"><a href="javascript:SortTable(1, 'T');">Job</a></th>
      <th scope="col-2"><a href="javascript:SortTable(2, 'T');">Status</a></th>
      <th scope="col-1"><a href="javascript:SortTable(3, 'D');">Date</a></th>
      <th scope="col-2"><a href="javascript:SortTable(4, 'T');">Tasks</a></th>
      <th scope="col-1"><a href="javascript:SortTable(5, 'D');">Due</a></th>
    </tr>
  </thead>

  <!-- TABLE ROWS -->
  <tbody>
    {% for status in all_active_status %}
      <tr>
        <!-- COMPANY NAME -->
        <td>
          <a href="/dashboard/companies/{{ status.jobs.companies.company_id }}">{{ status.jobs.companies.name }}</a>
        </td>

        <!-- JOB TITLE -->
        <td>
          <a href="/dashboard/jobs/{{ status.jobs.job_id }}">
            {{ status.jobs.title }}
          </a>
        </td>

        <!-- DROP DOWN STATUS MENU -->
        <td>
          <div class="dropdown">
            <form action="/dashboard/job-status" method="POST">

              <button class="btn dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                {{ status.job_codes.description }}
              </button>

              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <input type="hidden" name="job_id" value="{{ status.job_id }}">

                <button class="dropdown-item submit" type="submit" name="job_code" value="1">
                  Interested
                </button>

                <button class="dropdown-item submit" type="submit" name="job_code" value="2">
                  Applied
                </button>

                <button class="dropdown-item submit" type="submit" name="job_code" value="3">
                  Phone interview
                </button>

                <button class="dropdown-item submit" type="submit" name="job_code" value="4">
                  On-site interview
                </button>

                <button class="dropdown-item submit" type="submit" name="job_code" value="5">
                  Received offer
                </button>

                <button class="dropdown-item submit" type="submit" name="job_code" value="6">
                  Accepted offer
                </button>

                <button class="dropdown-item submit" type="submit" name="job_code" value="7">
                  Declined offer
                </button>

                <button class="dropdown-item submit" type="submit" name="job_code" value="8">
                  No job offer
                </button>
              
              </div>
            </form>
          </div>
        </td>

        <!-- DATE LAST MODIFIED -->
        <td>
          {{ status.date_created.strftime('%-m/%-d/%y') }}
        </td>

        <!-- TODO -->
        <td>
          {% for todo in all_todos %}
            {% if todo.job_event_id == status.job_event_id %}
              <span id="archiveTask">{{ todo.todo_codes.description }}</span>
            {% else %}
              {{ "" }}
            {% endif %}
          {% endfor %}
        </td>

        <td>
          {% for todo in all_todos %}
            {% if todo.job_event_id == status.job_event_id %}
              <span id="archiveDueDate">{{ todo.date_due.strftime('%-m/%-d/%y') }}</span>
              <form id="submitTaskArchive" action="/dashboard/archive-task" method="POST">
                <button id="archiveButton" class="btn" type="submit">
                  <input id="todo-id-field" type="hidden" name="todo_id" value="{{ todo.todo_id }}">
                  <i class="fas fa-archive"></i>
                </button>
              </form>
            {% else %}
              {{ "" }}
            {% endif %}
          {% endfor %}
        </td>
      </tr>
    {% endfor %}

  </tbody>
</table>


<!-- TASK ARCHIVE SCRIPT -->
<script type="text/javascript">

  function strikeArchiveTask(results) {
    $('#archiveTask').css({'text-decoration': 'line-through'});
    $('#archiveDueDate').css({'text-decoration': 'line-through'});
    $('#submitTaskArchive').hide();
    alert(results);
  }

  function sendArchiveTask(e) {
    console.log(e);
    e.preventDefault();

    const formInputs = {
      'todo_id': $('#todo-id-field').val(),
    };

    $.post('/dashboard/archive-task',
           formInputs,
           strikeArchiveTask);
  }  

  $('#submitTaskArchive').on('submit', sendArchiveTask);

</script>

<!-- TABLE SORT SCRIPT -->
<script type="text/javascript">
/* 
   Willmaster Table Sort Version 1.1 August 17, 2016
   Updated GetDateSortingKey() to correctly sort two-digit months and days numbers with leading 0.
   Version 1.0, July 3, 2011
   Will Bontrager https://www.willmaster.com/ Copyright 2011,2016 Will Bontrager Software, LLC
   This software is provided "AS IS," without any warranty of any kind, without even any implied warranty such as merchantability or fitness for a particular purpose. Will Bontrager Software, LLC grants you a royalty free license to use or modify this software provided this notice appears on all copies. 
*/

var TableIDvalue = "active-jobs-table";

//////////////////////////////////////
var TableLastSortedColumn = -1;
function SortTable() {
var sortColumn = parseInt(arguments[0]);
var type = arguments.length > 1 ? arguments[1] : 'T';
var dateformat = arguments.length > 2 ? arguments[2] : '';
var table = document.getElementById(TableIDvalue);
var tbody = table.getElementsByTagName("tbody")[0];
var rows = tbody.getElementsByTagName("tr");
var arrayOfRows = new Array();
type = type.toUpperCase();
dateformat = dateformat.toLowerCase();
for(var i=0, len=rows.length; i<len; i++) {
  arrayOfRows[i] = new Object;
  arrayOfRows[i].oldIndex = i;
  var celltext = rows[i].getElementsByTagName("td")[sortColumn].innerHTML.replace(/<[^>]*>/g,"");
  if( type=='D' ) { arrayOfRows[i].value = GetDateSortingKey(dateformat,celltext); }
  else {
    var re = type=="N" ? /[^\.\-\+\d]/g : /[^a-zA-Z0-9]/g;
    arrayOfRows[i].value = celltext.replace(re,"").substr(0,25).toLowerCase();
    }
  }
if (sortColumn == TableLastSortedColumn) { arrayOfRows.reverse(); }
else {
  TableLastSortedColumn = sortColumn;
  switch(type) {
    case "N" : arrayOfRows.sort(CompareRowOfNumbers); break;
    case "D" : arrayOfRows.sort(CompareRowOfNumbers); break;
    default  : arrayOfRows.sort(CompareRowOfText);
    }
  }
var newTableBody = document.createElement("tbody");
for(var i=0, len=arrayOfRows.length; i<len; i++) {
  newTableBody.appendChild(rows[arrayOfRows[i].oldIndex].cloneNode(true));
  }
table.replaceChild(newTableBody,tbody);
} // function SortTable()

function CompareRowOfText(a,b) {
var aval = a.value;
var bval = b.value;
return( aval == bval ? 0 : (aval > bval ? 1 : -1) );
} // function CompareRowOfText()

function CompareRowOfNumbers(a,b) {
var aval = /\d/.test(a.value) ? parseFloat(a.value) : 0;
var bval = /\d/.test(b.value) ? parseFloat(b.value) : 0;
return( aval == bval ? 0 : (aval > bval ? 1 : -1) );
} // function CompareRowOfNumbers()

function GetDateSortingKey(format,text) {
if( format.length < 1 ) { return ""; }
format = format.toLowerCase();
text = text.toLowerCase();
text = text.replace(/^[^a-z0-9]*/,"");
text = text.replace(/[^a-z0-9]*$/,"");
if( text.length < 1 ) { return ""; }
text = text.replace(/[^a-z0-9]+/g,",");
var date = text.split(",");
if( date.length < 3 ) { return ""; }
var d=0, m=0, y=0;
for( var i=0; i<3; i++ ) {
  var ts = format.substr(i,1);
  if( ts == "d" ) { d = date[i]; }
  else if( ts == "m" ) { m = date[i]; }
  else if( ts == "y" ) { y = date[i]; }
  }
d = d.replace(/^0/,"");
if( d < 10 ) { d = "0" + d; }
if( /[a-z]/.test(m) ) {
  m = m.substr(0,3);
  switch(m) {
    case "jan" : m = String(1); break;
    case "feb" : m = String(2); break;
    case "mar" : m = String(3); break;
    case "apr" : m = String(4); break;
    case "may" : m = String(5); break;
    case "jun" : m = String(6); break;
    case "jul" : m = String(7); break;
    case "aug" : m = String(8); break;
    case "sep" : m = String(9); break;
    case "oct" : m = String(10); break;
    case "nov" : m = String(11); break;
    case "dec" : m = String(12); break;
    default    : m = String(0);
    }
  }
m = m.replace(/^0/,"");
if( m < 10 ) { m = "0" + m; }
y = parseInt(y);
if( y < 100 ) { y = parseInt(y) + 2000; }
return "" + String(y) + "" + String(m) + "" + String(d) + "";
} // function GetDateSortingKey()
</script>

{% endblock %}
